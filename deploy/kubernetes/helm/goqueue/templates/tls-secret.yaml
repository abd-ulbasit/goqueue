{{- if .Values.security.tls.selfSigned }}
# =============================================================================
# SELF-SIGNED TLS CERTIFICATE (Development Only)
# =============================================================================
#
# ┌─────────────────────────────────────────────────────────────────────────────┐
# │ ⚠️  WARNING: FOR DEVELOPMENT AND TESTING ONLY                               │
# │                                                                             │
# │ In production, use:                                                         │
# │   1. cert-manager with Let's Encrypt                                        │
# │   2. AWS ACM + ALB/NLB for termination                                      │
# │   3. HashiCorp Vault PKI                                                    │
# │   4. External CA-signed certificates                                        │
# │                                                                             │
# │ This generates a self-signed cert using Helm's genSelfSignedCert function. │
# └─────────────────────────────────────────────────────────────────────────────┘
#
{{- $fullName := include "goqueue.fullname" . }}
{{- $namespace := .Release.Namespace }}
{{- $serviceName := printf "%s-headless" $fullName }}
{{- $altNames := list 
    "localhost"
    $fullName
    $serviceName
    (printf "%s.%s" $fullName $namespace)
    (printf "%s.%s.svc" $fullName $namespace)
    (printf "%s.%s.svc.cluster.local" $fullName $namespace)
    (printf "%s.%s" $serviceName $namespace)
    (printf "%s.%s.svc" $serviceName $namespace)
    (printf "%s.%s.svc.cluster.local" $serviceName $namespace)
    (printf "*.%s.%s.svc.cluster.local" $serviceName $namespace)
}}
{{- $ca := genCA "goqueue-ca" 3650 }}
{{- $cert := genSignedCert $fullName nil $altNames 365 $ca }}

apiVersion: v1
kind: Secret
metadata:
  name: {{ $fullName }}-tls
  namespace: {{ $namespace }}
  labels:
    {{- include "goqueue.labels" . | nindent 4 }}
  annotations:
    "helm.sh/resource-policy": "keep"
type: kubernetes.io/tls
data:
  tls.crt: {{ $cert.Cert | b64enc }}
  tls.key: {{ $cert.Key | b64enc }}
  ca.crt: {{ $ca.Cert | b64enc }}
---
# CA Certificate ConfigMap (for clients to trust)
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ $fullName }}-ca
  namespace: {{ $namespace }}
  labels:
    {{- include "goqueue.labels" . | nindent 4 }}
data:
  ca.crt: |
{{ $ca.Cert | indent 4 }}
{{- end }}

{{- if .Values.security.clusterTls.selfSigned }}
---
# =============================================================================
# CLUSTER mTLS CERTIFICATES (Inter-node Communication)
# =============================================================================
{{- $fullName := include "goqueue.fullname" . }}
{{- $namespace := .Release.Namespace }}
{{- $serviceName := printf "%s-headless" $fullName }}
{{- $clusterAltNames := list 
    "localhost"
    $fullName
    $serviceName
    (printf "%s.%s" $fullName $namespace)
    (printf "%s.%s.svc" $fullName $namespace)
    (printf "%s.%s.svc.cluster.local" $fullName $namespace)
    (printf "%s.%s" $serviceName $namespace)
    (printf "%s.%s.svc" $serviceName $namespace)
    (printf "%s.%s.svc.cluster.local" $serviceName $namespace)
    (printf "*.%s.%s.svc.cluster.local" $serviceName $namespace)
}}
{{- $clusterCa := genCA "goqueue-cluster-ca" 3650 }}
{{- $clusterCert := genSignedCert $fullName nil $clusterAltNames 365 $clusterCa }}

apiVersion: v1
kind: Secret
metadata:
  name: {{ $fullName }}-cluster-tls
  namespace: {{ $namespace }}
  labels:
    {{- include "goqueue.labels" . | nindent 4 }}
  annotations:
    "helm.sh/resource-policy": "keep"
type: kubernetes.io/tls
data:
  tls.crt: {{ $clusterCert.Cert | b64enc }}
  tls.key: {{ $clusterCert.Key | b64enc }}
  ca.crt: {{ $clusterCa.Cert | b64enc }}
{{- end }}

# =============================================================================
# GOQUEUE SERVICE (Main Client Access)
# =============================================================================
#
# This Service provides the main entry point for clients to connect to GoQueue.
# It load-balances requests across all healthy broker pods.
#
apiVersion: v1
kind: Service
metadata:
  name: {{ include "goqueue.fullname" . }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "goqueue.labels" . | nindent 4 }}
  {{- with .Values.service.annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
spec:
  type: {{ .Values.service.type }}
  {{- if eq .Values.service.type "LoadBalancer" }}
  externalTrafficPolicy: {{ .Values.service.externalTrafficPolicy }}
  {{- end }}
  ports:
    - name: http
      port: {{ .Values.service.httpPort }}
      targetPort: http
      protocol: TCP
    - name: grpc
      port: {{ .Values.service.grpcPort }}
      targetPort: grpc
      protocol: TCP
  selector:
    {{- include "goqueue.selectorLabels" . | nindent 4 }}
---
# =============================================================================
# GOQUEUE HEADLESS SERVICE (For StatefulSet DNS)
# =============================================================================
#
# ┌─────────────────────────────────────────────────────────────────────────────┐
# │ WHY HEADLESS SERVICE?                                                       │
# │                                                                             │
# │ Normal Service: DNS returns the Service's ClusterIP                         │
# │   nslookup goqueue → 10.0.0.100 (load balancer IP)                          │
# │                                                                             │
# │ Headless Service (clusterIP: None): DNS returns Pod IPs                     │
# │   nslookup goqueue-headless → 10.0.1.1, 10.0.1.2, 10.0.1.3                  │
# │   nslookup goqueue-0.goqueue-headless → 10.0.1.1                            │
# │                                                                             │
# │ USE CASES:                                                                  │
# │   - StatefulSet pods need to find each other by name                        │
# │   - Cluster membership discovery (each pod knows all peers)                 │
# │   - Leader election (followers connect directly to leader)                  │
# │   - Replication (leader knows which followers to push to)                   │
# └─────────────────────────────────────────────────────────────────────────────┘
#
apiVersion: v1
kind: Service
metadata:
  name: {{ include "goqueue.headlessServiceName" . }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "goqueue.labels" . | nindent 4 }}
  {{- with .Values.headlessService.annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
spec:
  type: ClusterIP
  clusterIP: None  # This makes it headless
  ports:
    - name: http
      port: {{ .Values.service.httpPort }}
      targetPort: http
      protocol: TCP
    - name: grpc
      port: {{ .Values.service.grpcPort }}
      targetPort: grpc
      protocol: TCP
    - name: internal
      port: {{ .Values.service.internalPort }}
      targetPort: internal
      protocol: TCP
  selector:
    {{- include "goqueue.selectorLabels" . | nindent 4 }}
  # publishNotReadyAddresses allows DNS resolution even for pods not yet ready
  # This is important for initial cluster formation where pods need to find each other
  publishNotReadyAddresses: true
